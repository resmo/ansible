---
- name: Test create server in check mode
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test'
    flavor: '{{ cloudscale_server_flavor }}'
    image: '{{ cloudscale_server_image }}'
    ssh_keys: '{{ cloudscale_server_ssh_key }}'
  register: server
  check_mode: yes
- name: Verify create server in check mode
  assert:
    that:
      - server is changed
      - server.state == 'absent'

- name: Test create server
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test'
    flavor: '{{ cloudscale_server_flavor }}'
    image: '{{ cloudscale_server_image }}'
    ssh_keys: '{{ cloudscale_server_ssh_key }}'
  register: server
- name: Verify create server
  assert:
    that:
      - server is changed
      - server.state == 'running'

- name: Test create server indempotence
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test'
    flavor: '{{ cloudscale_server_flavor }}'
    image: '{{ cloudscale_server_image }}'
    ssh_keys: '{{ cloudscale_server_ssh_key }}'
  register: server
- name: Verify create server
  assert:
    that:
      - server is not changed
      - server.state == 'running'

- name: Test create server stopped in check mode
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test-stopped'
    flavor: '{{ cloudscale_server_flavor }}'
    image: '{{ cloudscale_server_image }}'
    ssh_keys: '{{ cloudscale_server_ssh_key }}'
    state: stopped
  check_mode: yes
  register: server_stopped
- name: Verify create server stopped
  assert:
    that:
      - server_stopped is changed
      - server_stopped.state == 'absent'

- name: Test create server stopped
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test-stopped'
    flavor: '{{ cloudscale_server_flavor }}'
    image: '{{ cloudscale_server_image }}'
    ssh_keys: '{{ cloudscale_server_ssh_key }}'
    state: stopped
  register: server_stopped
- name: Verify create server stopped
  assert:
    that:
      - server_stopped is changed
      - server_stopped.state == 'stopped'

- name: Test create server stopped indempotence
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test-stopped'
    flavor: '{{ cloudscale_server_flavor }}'
    image: '{{ cloudscale_server_image }}'
    ssh_keys: '{{ cloudscale_server_ssh_key }}'
    state: stopped
  register: server_stopped
- name: Verify create server stopped indempotence
  assert:
    that:
      - server_stopped is not changed
      - server_stopped.state == 'stopped'

- name: Test create server failure without required parameters
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test-failed'
  register: server_failed
  ignore_errors: yes
- name: Verify create server failure without required parameters
  assert:
    that:
      - server_failed is failed
      - "'missing required arguments' in server_failed.msg"

- name: Test stop running server in check mode
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test'
    state: stopped
  check_mode: yes
  register: server
- name: Verify stop running server in check mode
  assert:
    that:
      - server is changed
      - server.state == 'running'

- name: Test stop running server
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test'
    state: stopped
  register: server
- name: Verify stop running server
  assert:
    that:
      - server is changed
      - server.state == 'stopped'

- name: Test stop running server indempotence
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test'
    state: 'stopped'
  register: server
- name: Verify stop running server indempotence
  assert:
    that:
      - server is not changed
      - server.state == 'stopped'

- name: Test server running in check mode
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test'
    state: running
  register: server
  check_mode: yes
- name: Verify server running in check mode
  assert:
    that:
      - server is changed
      - server.state == 'stopped'

- name: Test server running
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test'
    state: running
  register: server
- name: Verify server running
  assert:
    that:
      - server is changed
      - server.state == 'running'

- name: Test server running indempotence
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test'
    state: running
  register: server
- name: Verify server running indempotence
  assert:
    that:
      - server is not changed
      - server.state == 'running'

- name: Test server deletion by name
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test'
    state: 'absent'
  register: server
- name: Verify server deletion
  assert:
    that:
      - server is changed
      - server.state == 'absent'

- name: Test server deletion by uuid
  cloudscale_server:
    uuid: '{{ server_stopped.uuid }}'
    state: 'absent'
  register: server_stopped
- name: Verify server deletion by uuid
  assert:
    that:
      - server_stopped is changed
      - server_stopped.state == 'absent'

- name: Test server deletion indempotence
  cloudscale_server:
    name: '{{ cloudscale_resource_prefix }}-test'
    state: 'absent'
  register: server
- name: Verify server deletion
  assert:
    that:
      - server is not changed
      - server.state == 'absent'
